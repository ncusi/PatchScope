[![MIT License](https://img.shields.io/badge/License-MIT-green.svg)](https://choosealicense.com/licenses/mit/)
![Python](https://img.shields.io/badge/Python-3776AB?logo=python&logoColor=white)
![Python 3.8](https://img.shields.io/badge/python-3.8-blue.svg)
[![EditorConfig](https://img.shields.io/badge/Editor%20Config-E0EFEF?logo=editorconfig&logoColor=000)](https://editorconfig.org/)
[![Maturity badge - level 1](https://img.shields.io/badge/Maturity-Level%201%20--%20New%20Project-yellow.svg)](https://github.com/tophat/getting-started/blob/master/scorecard.md)

# Diff Annotator

Annotates files and lines of diffs (patches) with their purpose and type,
and performs statistical analysis on the generated annotation data.

## Installation

Use the package manager [pip](https://pip.pypa.io/en/stable/) to install diffannotator.

To avoid dependency conflicts, it is strongly recommended to create
a [virtual environment][venv] first, activate it, and install diffannotator
into this environment.  See also "_[Virtual environment](#virtual-environment)_"
subsection below.

To install the most recent version, use
```commandline
python -m pip install diffannotator@git+https://github.com/ncusi/python-diff-annotator#egg=main
```
or (assuming that you can clone the repository with SSH)
```commandline
python -m pip install diffannotator@git+ssh://git@github.com/ncusi/python-diff-annotator.git#egg=main
```

### Running scripts

This package installs scripts (currently three) that you can run
to generate patches, annotate them, and extract their statistics.
Every script name starts with the `diff-*` prefix.

Each script and subcommand supports the `--help` option.

- `diff-generate`: used to generate patches (*.patch and *.diff files)
  from a given repository, in the format suitable for later analysis;
  not strictly necessary;

  <u>Usage:</u> `diff-generate [OPTIONS] REPO_PATH [REVISION_RANGE...]`<br>
  (where `REVISION_RANGE...` is passed as arguments to the `git log` command)

- `diff-annotate`: annotates existing dataset (patch files in subdirectories),
  or annotates selected subset of commits (of changes in commits)
  in the given repository;

  <u>Usage:</u> `diff-annotate [OPTIONS] COMMAND [ARGS]...`

    - `diff-annotate patch [OPTIONS] PATCH_FILE RESULT_JSON`:
      annotate a single PATCH_FILE, writing results to RESULT_JSON,
    - `diff-annotate dataset [OPTIONS] DATASETS...`:
      annotate all bugs in provided DATASETS,
    - `diff-anotate from-repo [OPTIONS] REPO_PATH [REVISION_RANGE...]`:
      create annotation data for commits from local Git repository
      (with `REVISION_RANGE...` passed as arguments to the `git log` command);

- `diff-gather-stats`: compute various statistics and metrics
  from patch annotation data generated by the `diff-annotate` script;

  <u>Usage:</u> `diff-gather-stats [OPTIONS] COMMAND [ARGS]...`

    - `diff-gather-stats purpose-counter [--output JSON_FILE] DATASETS...`:
      calculate count of purposes from all bugs in provided datasets,
    - `diff-gather-stats purpose-per-file [OPTIONS] RESULT_JSON DATASETS...`:
      calculate per-file count of purposes from all bugs in provided datasets,
    - `diff-gather-stats lines-stats [OPTIONS] OUTPUT_FILE DATASETS...`:
      calculate per-bug and per-file count of line types in provided datasets,
    - `diff-gather-stats timeline [OPTIONS] OUTPUT_FILE DATASETS...`:
      calculate timeline of bugs with per-bug count of different types of lines;

- ...

### Jupyter Notebooks

The `notebooks/` directory contains Jupyter Notebooks with data exploration,
data analysis, etc.  See [`notebooks/README.md`](./notebooks/README.md)
for details.

## Development

### Virtual environment

To avoid dependency conflicts, it is strongly recommended to create
a [virtual environment][venv], for example with:
```commandline
python -m venv .venv
```

This needs to be done only once, from top directory of the project.
For each session, you should activate the environment:
```commandline
source .venv/bin/activate
```

Using virtual environment, either directly like shown above, or
by using `pipx`, might be required if you cannot install system
packages, but Python is configured in a very specific way:

> error: externally-managed-environment
>
> Ã— This environment is externally managed

[venv]: https://python.readthedocs.io/en/stable/library/venv.html

### Installing the package in editable mode

To install the project in editable mode (from top directory of this repo):
```commandline
python -m pip install -e .
```

To be able to also run test, use:
```commandline
python -m pip install --editable .[dev]
```

### Running tests

This project uses [pytest](https://docs.pytest.org/) framework.
Note that `pytest` requires Python 3.8+ or PyPy3.

To run tests, run the following command
```commandline
pytest
```
or
```commandline
python -m pytest
```

## Related projects

Here are some related projects that can also be used
to extract development statistics from project or a repository.

Command line and terminal interface tools:

- [`git-quick-stats`](https://git-quick-stats.sh/)
  ![Shell Script](https://img.shields.io/badge/shell_script-%23121011.svg?logo=gnu-bash&logoColor=white)
  is a simple and efficient way to access various statistics in a git repository
- [`git-stats`](https://github.com/IonicaBizau/git-stats)
  ![JavaScript](https://img.shields.io/badge/JavaScript-%23323330.svg?logo=JavaScript&logoColor=%23F7DF1E)
  provides local git statistics, including GitHub-like contributions calendars
- [`git_dash.sh`](https://github.com/darul75/git_dash)
  ![Shell Script](https://img.shields.io/badge/shell_script-%23121011.svg?logo=gnu-bash&logoColor=white)
  is a command-line shell script
  for generating a Git metrics dashboard directly in your terminal
- [`heatwave`](https://github.com/james-stoup/heatwave)
  ![Python](https://img.shields.io/badge/Python-3670A0?logo=Python&logoColor=ffdd54)
  visualizes your git commits with a heat map in the terminal,
  similar to how GitHub's heat map looks
- [`statscat`](https://github.com/z1cheng/statscat)
  ![Go](https://img.shields.io/badge/Go-%2300ADD8.svg?logo=Go&logoColor=white)
  is a CLI tool to get statistics of your all git repositories
- [hxtools](http://inai.de/projects/hxtools/)
  ![Perl](https://img.shields.io/badge/Perl-%2339457E.svg?logo=Perl&logoColor=white)
  by Jan Engelhardt
  is a collection of small tools and scripts, which include
  `git-author-stat` (commit author statistics of a git repository),
  `git-blame-stat` (per-line author statistics), and
  `git-revert-stats` (reverting statistics)
- [git-fame](https://github.com/casperdcl/git-fame) (in Python ![Python](https://img.shields.io/badge/Python-3670A0?logo=Python&logoColor=ffdd54)) and
  [git-fame-rb](https://github.com/oleander/git-fame-rb) (in Ruby ![Ruby](https://img.shields.io/badge/Ruby-%23CC342D.svg?logo=Ruby&logoColor=white))
  are command-line tools to pretty-print Git repository collaborators
  sorted by contributions
- [`git-of-theseus`](https://github.com/erikbern/git-of-theseus)
  ![Python](https://img.shields.io/badge/Python-3670A0?logo=Python&logoColor=ffdd54)
  is a set of scripts to analyze how a Git repo grows over time.
  - See [The half-life of code & the ship of Theseus](https://erikbern.com/2016/12/05/the-half-life-of-code.html)
    by Erik Bernhardsson (2016).
- GitHub [Linguist](https://github.com/github-linguist/linguist)
  ![Ruby](https://img.shields.io/badge/Ruby-%23CC342D.svg?logo=Ruby&logoColor=white)
  can also be used from the command line, using the `github-linguist` executable
  to generate repository's languages stats
  (the language breakdown by percentage and file size),
  also for selected revision
- [git-metrics](https://github.com/Praqma/git-metrics)
  ![Python](https://img.shields.io/badge/Python-3670A0?logo=Python&logoColor=ffdd54)
  tool is a set of util scripts to scrape data from git repositories
  to help teams improve (metrics such as lead time and open branches)

Tools to generate HTML dashboard, or providing an interactive web application:

- [GitStats](https://github.com/akashraj9828/gitstats)
  is an open source GitHub contribution analyzer, providing live dashboard;<br>
  **note** that [gitstats.me](https://gitstats.me/) no longer works
  (the domain is parked for sale)
- [`repostat`](https://github.com/vifactor/repostat)
  is Git repository analyser and HTML-report generator
  with [NVD3](https://nvd3.org/)-driven interactive metrics visualisations;<br>
  **note** that demo site <https://repostat.imfast.io/> no longer works
  - [NVD3.js](https://nvd3.org/) is an attempt to build re-usable charts
    and chart components for [d3.js](http://d3js.org/)
- [Repositorch](https://github.com/kirnosenko/Repositorch)
  is a Git repository analysis engine written in C#;
  it recommends using Docker Compose to install
  ([Repositorch on Docker Hub](https://hub.docker.com/r/kirnosenko/repositorch))<br>
  no demo site, but there is "[How to use Repositorch](https://www.youtube.com/watch?v=Rd5R0BbFdGA)"
  video on YouTube
- [cregit](https://github.com/cregit/cregit)
  is a tool for helping to find and analyse code credits
  (unify identities, find contribution by token,
  extract metadata into a SQLite database, etc.)
- [Githru](https://github.com/githru/githru) is an interactive visual analytics system
  that enables developers to effectively understand the context of development history
  through the [interactive exploration of Git and GitHub metadata (demo)](https://githru.github.io/demo/).
  It uses [novel techniques (paper)](https://arxiv.org/abs/2009.03115) (graph reconstruction,
  clustering, and Context-Preserving Squash Merge (CSM) methods) to abstract
  a large-scale Git commit graph.
- [Assayo](https://github.com/bakhirev/assayo) is a dashboard
  providing visualization and analysis of git commit statistics.
  Requires exporting data from Git.  Has a [homepage with demo](https://assayo.online/).
  Its use is described in _[The visualization and analysis of git commit statistics for IT team leaders](https://dev.to/responsivecrocodile/the-visualization-and-analysis-of-git-commit-statistics-for-it-team-leaders-2pof)_.

Visualizations for a specific repository:

- [A Git history visualization page](https://git-history.jpalmer.dev/)
  by Jeff Palmer shows _"An Interactive Development History"_ of Git:
  project and contributor statistics, relative cumulative contributions
  by contributor, and aggregated commits by contributor by month
  with milestone annotations.
  Jeff wrote [an associated blog post](https://jpalmer.dev/2021/05/interactive-git-history/)
  about how he created the visualization.
- [`gitdm`](https://github.com/npalix/gitdm) (the "git data miner")
  is the tool that Greg KH and Jonathan Corbet have used
  to create statistics on where kernel patches come from.
  Written in Python.  Original at `git://git.lwn.net/gitdm.git`

Web applications that demonstrate some MSR tool:

- [Assayo](https://github.com/bakhirev/assayo) has a
  [homepage with demo](https://assayo.online/) where you can
  provide the output of given Git CLI command in your repo
  to create the demo for your repo,
  and there is also view a demo with mock data.
  Written in JavaScript with React.
- [Githru](https://github.com/githru/githru) has an
  [interactive demo](https://githru.github.io/demo/),
  where you can select one of the following two GitHub repositories
  to visualize: `vuejs/vue` and `realm/realm-java`.
  Written in JavaScript with React, D3, dagre.
- [GitVision](https://github.com/gaspardIV/gitvision), a 3D repository
  graph visualization tool, has [live demo](https://gitvis.web.app/)
  with visualization for more than 20 repositories (ranging from tiny
  to large), and where you can visualize your own repository by
  uploading the result of running the [GitVision script](https://github.com/GaspardIV/gitvision/tree/main/tool).
  The demo [is written](https://github.com/GaspardIV/gitvision/tree/main/gitvisionwebapp)
  in JavaScript using Vue and deployed with Vite.
- [GitBug-Java](https://github.com/gitbugactions/gitbug-java),
  a reproducible Java benchmark of recent bugs (tool accompanying
  the _[GitBug-Java: A Reproducible Java Benchmark of Recent Bugs](https://doi.org/10.1145/3643991.3644884)_
  paper ([on arXiv](https://arxiv.org/abs/2402.02961))),
  has [web app visualizing the dataset](https://nfsaavedra.github.io/gitbug-java).
  No source code for the web app; it seems to be in JavaScript
  using Angular, with the help of Chart.js and diff2html.

## Contributing

Pull requests are welcome. For major changes, please open an issue first
to discuss what you would like to change.

Please make sure to update tests as appropriate.

## License

[MIT](https://choosealicense.com/licenses/mit/)
